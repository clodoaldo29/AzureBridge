services:
  # ========================================
  # Backend API
  # ========================================
  api:
    build:
      context: ./Backend
      dockerfile: Dockerfile
    container_name: azurebridge-api
    restart: unless-stopped
    user: "0:0"
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: production
      PORT: 3001
      HOST: 0.0.0.0
      # Database
      DATABASE_URL: ${DATABASE_URL}
      DATABASE_URL_FALLBACK: ${DATABASE_URL_FALLBACK:-}
      DATABASE_URL_SOURCE: ${DATABASE_URL_SOURCE:-primary}
      DIRECT_DATABASE_URL: ${DIRECT_DATABASE_URL}
      # Azure DevOps
      AZURE_DEVOPS_ORG_URL: ${AZURE_DEVOPS_ORG_URL}
      AZURE_DEVOPS_PAT: ${AZURE_DEVOPS_PAT}
      AZURE_DEVOPS_PROJECT: ${AZURE_DEVOPS_PROJECT}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      # Features
      FEATURE_ANALYTICS: ${FEATURE_ANALYTICS:-true}
      FEATURE_REPORTS: ${FEATURE_REPORTS:-true}
      RDA_UPLOADS_DIR: /app/uploads
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - azurebridge-network
    volumes:
      - api-logs:/app/logs
      - api-uploads:/app/uploads

  # ========================================
  # Auto Sync Scheduler
  # ========================================
  worker:
    build:
      context: ./Backend
      dockerfile: Dockerfile
    container_name: azurebridge-worker
    restart: unless-stopped
    user: "0:0"
    command: ["node", "dist/worker.js"]
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      DATABASE_URL_FALLBACK: ${DATABASE_URL_FALLBACK:-}
      DATABASE_URL_SOURCE: ${DATABASE_URL_SOURCE:-primary}
      DIRECT_DATABASE_URL: ${DIRECT_DATABASE_URL}
      AZURE_DEVOPS_ORG_URL: ${AZURE_DEVOPS_ORG_URL}
      AZURE_DEVOPS_PAT: ${AZURE_DEVOPS_PAT}
      AZURE_DEVOPS_PROJECT: ${AZURE_DEVOPS_PROJECT}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      RDA_UPLOADS_DIR: /app/uploads
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - azurebridge-network
    volumes:
      - api-logs:/app/logs
      - api-uploads:/app/uploads

  auto-sync:
    build:
      context: ./Backend
      dockerfile: Dockerfile.scheduler
    container_name: azurebridge-auto-sync
    restart: unless-stopped
    environment:
      NODE_ENV: production
      # Database
      DATABASE_URL: ${DATABASE_URL}
      DATABASE_URL_FALLBACK: ${DATABASE_URL_FALLBACK:-}
      DATABASE_URL_SOURCE: ${DATABASE_URL_SOURCE:-primary}
      DIRECT_DATABASE_URL: ${DIRECT_DATABASE_URL}
      # Azure DevOps
      AZURE_DEVOPS_ORG_URL: ${AZURE_DEVOPS_ORG_URL}
      AZURE_DEVOPS_PAT: ${AZURE_DEVOPS_PAT}
      AZURE_DEVOPS_PROJECT: ${AZURE_DEVOPS_PROJECT}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      # Redis (if needed by any scripts)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      # Scheduler
      AUTO_SYNC_CRON_HOURLY: ${AUTO_SYNC_CRON_HOURLY:-0 * * * *}
      AUTO_SYNC_CRON_DAILY: ${AUTO_SYNC_CRON_DAILY:-0 2 * * *}
      AUTO_SYNC_RUN_ON_START: ${AUTO_SYNC_RUN_ON_START:-false}
      AUTO_SYNC_RUN_ON_START_MODE: ${AUTO_SYNC_RUN_ON_START_MODE:-daily}
      AUTO_SYNC_NEW_PROJECTS: ${AUTO_SYNC_NEW_PROJECTS:-false}
      TZ: ${TZ:-UTC}
    depends_on:
      api:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - azurebridge-network

  # ========================================
  # Frontend Web
  # ========================================
  web:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
      args:
        VITE_AZURE_DEVOPS_ORG_URL: ${AZURE_DEVOPS_ORG_URL}
    container_name: azurebridge-web
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - azurebridge-network

  # ========================================
  # Redis Cache
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: azurebridge-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
    command: >
      sh -c 'if [ -n "$$REDIS_PASSWORD" ]; then redis-server --appendonly yes --requirepass "$$REDIS_PASSWORD"; else redis-server --appendonly yes; fi'
    volumes:
      - redis-data:/data
    networks:
      - azurebridge-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  azurebridge-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
  api-logs:
    driver: local
  api-uploads:
    driver: local
